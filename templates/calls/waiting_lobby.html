{% extends 'base.html' %}

{% block title %}Waiting Lobby{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="flex justify-center">
        <div class="w-full max-w-2xl">
            <div class="medical-card">
                <div class="bg-medical-blue text-white p-4 sm:p-6 rounded-t-lg">
                    <h4 class="text-center text-lg sm:text-xl font-bold">Video Call Lobby</h4>
                    <p class="text-center mb-0 text-sm sm:text-base opacity-90">Token: <strong>{{ appointment.call_token }}</strong></p>
                </div>
                <div class="p-4 sm:p-6 text-center">
                    <div class="mb-6">
                        <h5 class="text-base sm:text-lg font-semibold mb-3">Appointment Details</h5>
                        <div class="space-y-2 text-sm sm:text-base">
                            <p><strong>Doctor:</strong> {{ appointment.doctor.get_full_name|default:appointment.doctor.username }}</p>
                            <p><strong>Patient:</strong> {{ appointment.patient.get_full_name|default:appointment.patient.username }}</p>
                            <p><strong>Date:</strong> {{ appointment.date }} at {{ appointment.time }}</p>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="text-base sm:text-lg font-semibold mb-4">Participants Status</h5>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="participant-status">
                                <i class="fas fa-user-md text-3xl sm:text-4xl mb-2 {% if session.doctor_joined %}text-green-500{% else %}text-gray-400{% endif %}"></i>
                                <p class="text-sm sm:text-base font-medium">Doctor</p>
                                <span class="inline-block px-3 py-1 rounded-full text-xs font-medium {% if session.doctor_joined %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-600{% endif %}">
                                    {% if session.doctor_joined %}Joined{% else %}Waiting...{% endif %}
                                </span>
                            </div>
                            <div class="participant-status">
                                <i class="fas fa-user text-3xl sm:text-4xl mb-2 {% if session.patient_joined %}text-green-500{% else %}text-gray-400{% endif %}"></i>
                                <p class="text-sm sm:text-base font-medium">Patient</p>
                                <span class="inline-block px-3 py-1 rounded-full text-xs font-medium {% if session.patient_joined %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-600{% endif %}">
                                    {% if session.patient_joined %}Joined{% else %}Waiting...{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="status-message" class="mb-6">
                        <div class="bg-green-100 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
                            <i class="fas fa-check-circle mr-2"></i> Ready to start video call!
                        </div>
                    </div>
                    
                    <div id="join-button">
                        <a href="{% url 'video_room' appointment.call_token %}" class="btn-medical inline-flex items-center px-6 py-3 text-base font-medium">
                            <i class="fas fa-video mr-2"></i> Start Video Call
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Poll for lobby status updates
function checkLobbyStatus() {
    fetch(`/calls/api/lobby-status/{{ appointment.call_token }}/`)
        .then(response => response.json())
        .then(data => {
            if (data.both_joined) {
                document.getElementById('status-message').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Both participants have joined! Starting video call...
                    </div>
                `;
                document.getElementById('join-button').style.display = 'block';
                
                // Update participant status
                updateParticipantStatus('doctor', data.doctor_joined);
                updateParticipantStatus('patient', data.patient_joined);
                
                // Auto-redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = "{% url 'video_room' appointment.call_token %}";
                }, 2000);
            } else {
                updateParticipantStatus('doctor', data.doctor_joined);
                updateParticipantStatus('patient', data.patient_joined);
            }
        })
        .catch(error => console.error('Error checking lobby status:', error));
}

function updateParticipantStatus(role, joined) {
    const icon = document.querySelector(`.participant-status i.fa-user${role === 'doctor' ? '-md' : ''}`);
    const badge = icon.parentElement.querySelector('.badge');
    
    if (joined) {
        icon.classList.remove('text-muted');
        icon.classList.add('text-success');
        badge.classList.remove('bg-secondary');
        badge.classList.add('bg-success');
        badge.textContent = 'Joined';
    } else {
        icon.classList.remove('text-success');
        icon.classList.add('text-muted');
        badge.classList.remove('bg-success');
        badge.classList.add('bg-secondary');
        badge.textContent = 'Waiting...';
    }
}

// Check status every 2 seconds
{% if not both_joined %}
setInterval(checkLobbyStatus, 2000);
{% endif %}
</script>
{% endblock %}